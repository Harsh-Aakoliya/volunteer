// ==================== VIDEO CALL RELATED CODE ====================

// 1. IMPORTS
import VideoCallNotification from "@/components/chat/VideoCallNotification";
/** other imports related to chatting functionality **/

// 2. STATE VARIABLES
// Video call notification state
const [showVideoCallNotification, setShowVideoCallNotification] = useState(false);
const [videoCallData, setVideoCallData] = useState<{ callerId: string; callerName: string } | null>(null);
/** other state variables related to chatting functionality **/

// 3. VIDEO CALL INITIATION LISTENER
// Handle video call initiation notification
useEffect(() => {
  if (!isConnected || !roomId) return;

  const videoCallInitSub = socketManager.on('video-call-initiate', (data: any) => {
    if (data.roomId === (Array.isArray(roomId) ? roomId[0] : roomId) && data.callerId !== currentUser?.userId) {
      console.log('ðŸ“¹ Video call initiated by:', data.callerName);
      setVideoCallData({
        callerId: data.callerId,
        callerName: data.callerName,
      });
      setShowVideoCallNotification(true);
    }
  });

  return () => {
    socketManager.off(videoCallInitSub);
  };
}, [isConnected, roomId, currentUser?.userId]);

/** other useEffect hooks related to chatting functionality **/

// 4. VIDEO CALL HANDLERS
// Handle video call acceptance
const handleAcceptVideoCall = useCallback(() => {
  setShowVideoCallNotification(false);
  router.push({
    pathname: '/chat/video-call',
    params: { 
      roomId: Array.isArray(roomId) ? roomId[0] : roomId,
      joining: 'true', // Mark that this user is joining an existing call
    },
  });
}, [roomId, router]);

// Handle video call rejection
const handleRejectVideoCall = useCallback(() => {
  setShowVideoCallNotification(false);
  if (roomId) {
    socketManager.rejectVideoCall(Array.isArray(roomId) ? roomId[0] : roomId);
  }
  setVideoCallData(null);
}, [roomId]);

// Handle video call button press (initiate video call)
const handleVideoCallPress = useCallback(() => {
  if (!roomId) {
    Alert.alert('Error', 'Room ID is missing');
    return;
  }
  
  router.push({
    pathname: '/chat/video-call',
    params: { roomId: Array.isArray(roomId) ? roomId[0] : roomId },
  });
}, [roomId, router]);

/** other handler functions related to chatting functionality **/

// 5. HEADER COMPONENT (TelegramHeader) - Video Call Button
const TelegramHeader = React.memo(({
  roomName,
  memberCount,
  onlineCount,
  onBackPress,
  onAvatarPress,
  onMenuPress,
  onVideoCallPress,  // Video call prop
  isSyncing,
}: {
  roomName: string;
  memberCount: number;
  onlineCount: number;
  onBackPress: () => void;
  onAvatarPress: () => void;
  onMenuPress?: () => void;
  onVideoCallPress?: () => void;  // Video call prop type
  isSyncing: boolean;
}) => {
  /** other TelegramHeader code **/

  return (
    <View style={styles.header}>
      /** other header elements **/

      <View style={styles.headerActions}>
        {onVideoCallPress && (
          <TouchableOpacity onPress={onVideoCallPress} style={styles.headerIconButton}>
            <Ionicons name="videocam" size={24} color="#000" />
          </TouchableOpacity>
        )}
        /** other action buttons **/
      </View>
    </View>
  );
});

// 6. HEADER USAGE - Passing Video Call Handler
/** other render code **/

{selectedMessages.length > 0 ? (
  /** selection header **/
) : (
  <TelegramHeader
    roomName={room?.roomName || "Chat"}
    memberCount={roomMembers.length}
    onlineCount={onlineUsers.length}
    onBackPress={() => router.back()}
    onAvatarPress={() => setShowMembersModal(true)}
    onMenuPress={isGroupAdmin ? () => router.push({
      pathname: "/chat/room-info",
      params: { roomId },
    }) : undefined}
    onVideoCallPress={handleVideoCallPress}  // Video call handler
    isSyncing={isSyncing}
  />
)}

/** other render code **/

// 7. VIDEO CALL NOTIFICATION COMPONENT
{/* Video Call Notification */}
<VideoCallNotification
  visible={showVideoCallNotification}
  callerName={videoCallData?.callerName || 'Unknown'}
  roomName={room?.roomName || 'Chat Room'}
  onAccept={handleAcceptVideoCall}
  onReject={handleRejectVideoCall}
/>

/** other modals and components **/

// ==================== END OF VIDEO CALL RELATED CODE ====================

